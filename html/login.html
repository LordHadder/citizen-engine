<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Login Page</title>
  </head>
  <body onload="init();">
    <div id="divheader" style="display: none;">Login Page</div>
    <div id="divbody" style="display: none;">
      <form method="post" action="/login" onsubmit="return validateBeforeSubmit();">
        <input type="text" name="username" onblur="validateUser(this)" id="inputusername"/><span id="spanusername">User</span><br/>
        <input type="password" name="password" onblur="validatePassword(this)" id="inputpassword"/><span id="spanpassword">Password</span><br/>
        <div id="divpasswordnew" style="display:none;">
          <br/>
          <input type="password" name="newpassword" id="inputnewpassword" onblur="newPasswordChange()"/><span id="spannewpassword">New Password</span><br/>
          <input type="password" name="newpasswordconfirm" id="inputnewpasswordconfirm" onblur="newPasswordConfirmChange()"/><span id="spannewpasswordconfirm">Confirm Password</span><br/>
          <br/>
        </div>
        <input type="submit" value="LogIn" id="buttonlogin"/>
      </form>
      <button onclick="togglePasswordChange()" id="buttonpasswordchange">Change Password</button>
    </div>
    <div id="divfooter" style="display: none;"><span id="spanloginmess"></span></div>
    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="/citizeng.css/common.css">
    <link rel="stylesheet" type="text/css" href="/css/citizeng.css">
    <!-- Style -->
    <!-- Script -->
    <script src="/citizeng.js/mobile-detect.min.js"></script>
    <script src="/citizeng.js/common.js"></script>
    <script src="/js/citizeng.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      /* Global variables. */
      var ctzClientInfo = { browser:""
                          , devide:""
                          , os:""};
      var messagelogin =  [ "!! Password field is empty !!"
                          , "!! Unknown user !!"
                          , "!! New password does not match !!"];
      var ctxloginform =  { buttonpasswordchange:null
                          , divpasswordnew:null
                          , passwordnew:null
                          , passwordnewconfirm:null};
      var buttonlogin = null;
      var spanloginmess = null;
      var inputusername = null;
      var password = null;
      var socket = io.connect();

      /* Initialization function. */
      function init() {
        // hide main elements.
        elemdivloginheader = document.getElementById("divheader");
        elemdivloginbody   = document.getElementById("divbody");
        elemdivloginfooter = document.getElementById("divfooter");

        // Reset contextual form.
        if (null != (ctxloginform.buttonpasswordchange  = document.getElementById("buttonpasswordchange"))) {ctxloginform.buttonpasswordchange.disabled = true;}
        if (null != (ctxloginform.divpasswordnew        = document.getElementById("divpasswordnew"))) {ctxloginform.divpasswordnew.style.display = "none";}
        if (null != (ctxloginform.passwordnew           = document.getElementById("inputnewpassword"))) {ctxloginform.passwordnew.value = "";}
        if (null != (ctxloginform.passwordnewconfirm    = document.getElementById("inputnewpasswordconfirm"))) {ctxloginform.passwordnewconfirm.value = "";}

        // Set login button element.
        if (null != (buttonlogin = document.getElementById("buttonlogin"))) {
          buttonlogin.disabled = true;
        }
        
        // Set message span element.
        if (null != (spanloginmess = document.getElementById("spanloginmess"))) {
          spanloginmess.innerHTML = "";
        }
        
        // Set user name input element.
        if (null != (inputusername = document.getElementById("inputusername"))) {
          inputusername.value = "";
        }

        // Set user password element.
        if (null != (password = document.getElementById("inputpassword"))) {
          password.value = "";
        }

        // Set client information.
        var md = new MobileDetect(window.navigator.userAgent);
        var mobile = md.mobile();
        var device = md.phone();
        if ((null == md) || (null == mobile)) {
          ctzClientInfo.browser = ctzGetBrowser();
          ctzClientInfo.device = "desktop";
          ctzClientInfo.os = ctzGetOS();
        }
        else {
          if (null == (ctzClientInfo.browser = md.userAgent())) ctzClientInfo.browser = "unknown";
          if (null == (ctzClientInfo.device = (null == device)? md.tablet() : device)) ctzClientInfo.device = "unknown";
          if (null == (ctzClientInfo.os = md.os())) ctzClientInfo.os = "unknown";
        }

        // Custom initialization.
        initlogin();
      }

      /* User name validation function. */
      function validateUser(ithis) {
        // Field is not empty.
        if (0 < ithis.value.length) {
          buttonlogin.disabled = true;
          spanloginmess.innerHTML = "";
          ctxloginform.buttonpasswordchange.disabled = true;

          // Check user name is registered.
          socket.emit("userpresent", ithis.value, function(err, row) {
            // User not found.
            if (null != err) {
              spanloginmess.innerHTML = messagelogin[1];//(0 < err.message.length)? (err.message) : ("!!? Bad response for '" + ithis.value + "' ?!!");
            }
            // User found.
            else {
              buttonlogin.disabled = false;
              ctxloginform.buttonpasswordchange.disabled = false;
              ctxloginform.passwordnew.disabled = false;
              ctxloginform.passwordnewconfirm.disabled = false;

              // Save user name in a cookie.
              setCookie("citizeng-whoami", row.username);

              // Am i super user in a cookie.
              setCookie("citizeng-amisuper", row.super);
            }
          });
        }
        // Field is empty.
        else {
          buttonlogin.disabled = true;
          ctxloginform.buttonpasswordchange.disabled = true;
          ctxloginform.passwordnew.disabled = true;
          ctxloginform.passwordnewconfirm.disabled = true;
        }
      }

      /* User password validation function. */
      function validatePassword(ithis) {
        // Field is not empty.
        if (0 < ithis.value.length) {
          buttonlogin.disabled = false;
          ctxloginform.buttonpasswordchange.disabled = false;
          ctxloginform.passwordnew.disabled = false;
          ctxloginform.passwordnewconfirm.disabled = false;
          spanloginmess.innerHTML = "";
        }
        // Field is empty.
        else {
          buttonlogin.disabled = true;
          ctxloginform.buttonpasswordchange.disabled = true;
          ctxloginform.passwordnew.disabled = true;
          ctxloginform.passwordnewconfirm.disabled = true;
          spanloginmess.innerHTML = messagelogin[0];
        }
      }

      /* Vaidation function */
      function validateBeforeSubmit() {
        if (ctxloginform.passwordnew.value !== ctxloginform.passwordnewconfirm.value) {
          ctxloginform.passwordnew.value = "";
          ctxloginform.passwordnewconfirm.value = "";
          spanloginmess.innerHTML = messagelogin[2];
        }
        else {
          // Password field is empty.
          if (0 == password.value.length) {
            spanloginmess.innerHTML = messagelogin[0];
          }
          else {
            // Ok.
            return true;
          }
        }

        // Oops.
        return false;
      }

      /* Toggle function */
      function togglePasswordChange() {
        toggleDiv(divpasswordnew);
        ctxloginform.passwordnew.value = "";
        ctxloginform.passwordnewconfirm.value = "";
      }

      /* New password changed function. */
      function newPasswordChange() {
        ctxloginform.buttonpasswordchange.disabled = false;
      }

      /* New password confirmed function. */
      function newPasswordConfirmChange() {
        ctxloginform.buttonpasswordchange.disabled = false;
      }
    </script>
    <!-- Script -->
  </body>
</html>
